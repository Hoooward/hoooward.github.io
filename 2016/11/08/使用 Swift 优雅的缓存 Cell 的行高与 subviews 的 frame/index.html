<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>  · Hexo</title><meta name="description" content=" - John Doe"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Hexo"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/1855353313/" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/Hoooward" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title"></h1><div class="post-info">Nov 8, 2016</div><div class="post-content"><h1 id="在-Swift-中优雅的缓存-cell-的行高与-subviews-的-layout"><a href="#在-Swift-中优雅的缓存-cell-的行高与-subviews-的-layout" class="headerlink" title="在 Swift 中优雅的缓存 cell 的行高与 subviews 的 layout"></a>在 Swift 中优雅的缓存 cell 的行高与 subviews 的 layout</h1><p><code>UITableView</code> 与 <code>UICollectionView</code> 无疑是 iOS 开发中使用最多的视图控制器，它往往负责展示大量的数据. 伴随着用户的手指不断的滑动，系统会反复刷新UI, 加载所要展示的内容。而一旦数据体积增大，计算的逻辑复杂，就会造成过多的性能浪费。解决这类问题的方法有很多. 最近在 <code>Yep</code> 代码中看到的方法，在应用到自己项目的时候感觉非常不错, 所以有了以下的记录总结.</p>
<p>首先看一下 Demo 要实现的效果<br><a id="more"></a><br><img src="http://7xrfzx.com1.z0.glb.clouddn.com/2016-11-08-IMG_0230.jpg" alt=""></p>
<p>既然要利用代码的方式实现这样的效果，我们现在分析一下实现的具体过程。</p>
<ul>
<li>图中是一个 TableViewController</li>
<li>有三种不同的 cell 样式</li>
<li>三种不同的 cell 包含一些共同的元素，比如 nickName，avatorImage，还有 comment count，以及 category</li>
</ul>
<p>我们可以先创建一个基类 <code>FeedBaseCell</code>, 用来定义三种样式的公共元素.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FeedBaseCell</span>: <span class="title">UITableViewCell</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// 控制文本内容使用的 textView 最大的宽度.</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">let</span> messageTextViewMaxWidth: <span class="type">CGFloat</span> = &#123;</div><div class="line">        <span class="keyword">let</span> maxWidth = <span class="type">UIScreen</span>.main.bounds.width - (<span class="number">15</span> + <span class="number">40</span> + <span class="number">10</span> + <span class="number">15</span>)</div><div class="line">        <span class="keyword">return</span> maxWidth</div><div class="line">    &#125;()</div><div class="line">    </div><div class="line">    <span class="comment">// 用来配置 cell 时使用的 feed 实例</span></div><div class="line">    <span class="keyword">var</span> feed: <span class="type">Feed</span>?</div><div class="line">    </div><div class="line">    <span class="comment">// 控制 subViews 点击事件</span></div><div class="line">    <span class="keyword">var</span> tapAvataraction: ((<span class="type">FeedBaseCell</span>) -&gt; <span class="type">Void</span>)?</div><div class="line">    <span class="keyword">var</span> touchesBeganAction: ((<span class="type">UITableViewCell</span>) -&gt; <span class="type">Void</span>)?</div><div class="line">    <span class="keyword">var</span> touchesEndedAction: ((<span class="type">UITableViewCell</span>) -&gt; <span class="type">Void</span>)?</div><div class="line">    <span class="keyword">var</span> touchesCancelledAction: ((<span class="type">UITableViewCell</span>) -&gt; <span class="type">Void</span>)?</div><div class="line">    </div><div class="line">     <span class="built_in">lazy</span> <span class="keyword">var</span> avatarImageView: <span class="type">UIImageView</span> = &#123;</div><div class="line">        <span class="keyword">let</span> imageView = <span class="type">UIImageView</span>()</div><div class="line">        <span class="comment">// 自定义样式省略...</span></div><div class="line">        <span class="keyword">return</span> imageView</div><div class="line">    &#125;()</div><div class="line">    </div><div class="line">    <span class="built_in">lazy</span> <span class="keyword">var</span> nickNameLabel: <span class="type">UILabel</span> = &#123;</div><div class="line">        <span class="keyword">let</span> label = <span class="type">UILabel</span>()</div><div class="line">        <span class="comment">// 自定义样式省略...</span></div><div class="line">        <span class="keyword">return</span> label</div><div class="line">    &#125;()</div><div class="line">    </div><div class="line">    <span class="built_in">lazy</span> <span class="keyword">var</span> categoryButton: <span class="type">UIButton</span> = &#123;</div><div class="line">        <span class="keyword">let</span> button = <span class="type">UIButton</span>()</div><div class="line">       <span class="comment">// 自定义样式省略...</span></div><div class="line">        <span class="keyword">return</span> button</div><div class="line">    &#125;()</div><div class="line">    </div><div class="line">    <span class="built_in">lazy</span> <span class="keyword">var</span> messageTextView: <span class="type">FeedTextView</span> = &#123;</div><div class="line">        <span class="keyword">let</span> textView = <span class="type">FeedTextView</span>()</div><div class="line">        <span class="comment">// 自定义样式省略...</span></div><div class="line">        <span class="keyword">return</span> textView</div><div class="line">    &#125;()</div><div class="line">    </div><div class="line">    <span class="built_in">lazy</span> <span class="keyword">var</span> leftBottomLabel: <span class="type">UILabel</span> = &#123;</div><div class="line">        <span class="keyword">let</span> label = <span class="type">UILabel</span>()</div><div class="line">        <span class="comment">// 自定义样式省略...</span></div><div class="line">        <span class="keyword">return</span> label</div><div class="line">    &#125;()</div><div class="line">    </div><div class="line">    <span class="built_in">lazy</span> <span class="keyword">var</span> messageCountLabel: <span class="type">UILabel</span> = &#123;</div><div class="line">        <span class="keyword">let</span> label = <span class="type">UILabel</span>()</div><div class="line">        <span class="comment">// 自定义样式省略...</span></div><div class="line">        <span class="keyword">return</span> label</div><div class="line">    &#125;()</div></pre></td></tr></table></figure>
<p><code>FeedBaseCell</code> 中不仅包换其中的 subviews 实例，还需实现一个 <code>heightForFeed</code> 的方法用来计算 cell 的高度.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// 通过Feed内容计算高度</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">heightOfFeed</span>(<span class="title">feed</span>: <span class="title">Feed</span>) -&gt; <span class="title">CGFloat</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">let</span> rect = (feed.contentBody! <span class="keyword">as</span> <span class="type">NSString</span>).boundingRect(with:</div><div class="line">         <span class="type">CGSize</span>(width: <span class="type">FeedBaseCell</span>.messageTextViewMaxWidth, height: </div><div class="line">         <span class="type">CGFloat</span>(<span class="type">FLT_MAX</span>)), options: </div><div class="line">         [.usesLineFragmentOrigin, .usesFontLeading], attributes: </div><div class="line">         [<span class="type">NSFontAttributeName</span>: <span class="type">UIFont</span>.systemFont(ofSize: <span class="number">17</span>)], context: <span class="literal">nil</span>)</div><div class="line">    </div><div class="line">    <span class="keyword">let</span> height: <span class="type">CGFloat</span> = <span class="number">10</span> + <span class="number">40</span> + ceil(rect.height) + <span class="number">4</span> + <span class="number">15</span> + <span class="number">17</span> + <span class="number">15</span></div><div class="line">    <span class="keyword">return</span> ceil(height)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着我们在 <code>FeedBaseCell</code> 的初始化方法中将 subviews 实例添加到 contentView.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="keyword">init</span>(style: <span class="type">UITableViewCellStyle</span>, reuseIdentifier: <span class="type">String</span>?) &#123;</div><div class="line">    <span class="keyword">super</span>.<span class="keyword">init</span>(style: style, reuseIdentifier: reuseIdentifier)</div><div class="line">    contentView.addSubview(avatarImageView)</div><div class="line">    contentView.addSubview(nickNameLabel)</div><div class="line">    contentView.addSubview(categoryButton)</div><div class="line">    contentView.addSubview(messageTextView)</div><div class="line">    contentView.addSubview(leftBottomLabel)</div><div class="line">    contentView.addSubview(messageCountLabel)</div><div class="line">    contentView.addSubview(discussionImageView)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而 <code>FeedAnyImagesCell</code> 和 <code>FeedBigImageCell</code> 都继承自 <code>FeedBaseCell</code>. 我们重写其父类的 heightOfFeed 方法.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FeedAnyImagesCell</span>: <span class="title">FeedBaseCell</span>  </span>&#123;</div><div class="line">    <span class="comment">// 显示 images 的视图创建省略.</span></div><div class="line">    <span class="keyword">override</span> <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">heightOfFeed</span>(<span class="title">feed</span>: <span class="title">Feed</span>) -&gt; <span class="title">CGFloat</span> </span>&#123;</div><div class="line">        <span class="keyword">let</span> height = <span class="keyword">super</span>.heightOfFeed(feed: feed) + </div><div class="line">        <span class="type">Config</span>.<span class="type">FeedAnyImagesCell</span>.imageSize.height + <span class="number">15</span></div><div class="line">         <span class="keyword">return</span> ceil(height)</div><div class="line">     &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FeedBiggerImageCell</span>: <span class="title">FeedBaseCell</span> </span>&#123;</div><div class="line">    <span class="comment">// 显示 image 的视图创建省略.</span></div><div class="line">    <span class="keyword">override</span> <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">heightOfFeed</span>(<span class="title">feed</span>: <span class="title">Feed</span>) -&gt; <span class="title">CGFloat</span> </span>&#123;</div><div class="line">        <span class="keyword">let</span> height = <span class="keyword">super</span>.heightOfFeed(feed: feed) + </div><div class="line">         <span class="type">Config</span>.<span class="type">FeedBiggerImageCell</span>.imageSize.height + <span class="number">15</span></div><div class="line">        <span class="keyword">return</span> ceil(height)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>三种样式的 cell 创建完成后, 我们需要定义一个 <code>FeedCellLayout</code> 的结构体, 用来封装不同 cell 类型所对应的 layout 布局.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FeedCellLayout</span> </span>&#123;</div><div class="line">    <span class="keyword">let</span> screenWidth = <span class="type">UIScreen</span>.main.bounds.width</div><div class="line">    <span class="comment">// 三种类型 cell 的公共元素.</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">DefaultLayout</span> </span>&#123;</div><div class="line">        <span class="keyword">let</span> avatarImageViewFrame: <span class="type">CGRect</span></div><div class="line">        <span class="keyword">let</span> nicknameLabelFrame: <span class="type">CGRect</span></div><div class="line">        <span class="keyword">let</span> categoryButtonFrame: <span class="type">CGRect</span></div><div class="line">        <span class="keyword">let</span> messageTextViewFrame: <span class="type">CGRect</span></div><div class="line">        <span class="keyword">let</span> leftBottomLabelFrame: <span class="type">CGRect</span></div><div class="line">        <span class="keyword">let</span> messageCountLabelFrame: <span class="type">CGRect</span></div><div class="line">        <span class="keyword">let</span> discussionImageViewFrame: <span class="type">CGRect</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">var</span> defaultLayout: <span class="type">DefaultLayout</span></div><div class="line">    </div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">BiggerImageLayout</span> </span>&#123;</div><div class="line">        <span class="keyword">let</span> biggerImageViewFrame: <span class="type">CGRect</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">var</span> biggerImageLayout: <span class="type">BiggerImageLayout</span>?</div><div class="line">    </div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">AnyImagesLayout</span> </span>&#123;</div><div class="line">        <span class="keyword">let</span> mediaCollectionViewFrame: <span class="type">CGRect</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">var</span> anyImagesLayout: <span class="type">AnyImagesLayout</span>?</div><div class="line">    </div><div class="line">    <span class="comment">// cell的高度</span></div><div class="line">    <span class="keyword">var</span> height: <span class="type">CGFloat</span> = <span class="number">0</span></div><div class="line">    </div><div class="line">    <span class="comment">// init</span></div><div class="line">    <span class="keyword">init</span>(feed: <span class="type">Feed</span>) &#123;</div><div class="line">         <span class="comment">/* init 方法中接受一个 feed 实例,</span></div><div class="line">           我们通过此实例中的附件类型来调用响应的计算cell高度.</div><div class="line">         */</div><div class="line">        <span class="keyword">switch</span> feed.attachment &#123;</div><div class="line">        <span class="keyword">case</span> .<span class="type">Text</span>:</div><div class="line">            height = <span class="type">FeedBaseCell</span>.heightOfFeed(feed: feed)</div><div class="line">        <span class="keyword">case</span> .<span class="type">Image</span>(<span class="keyword">let</span> imagesAttachments):</div><div class="line">            printLog(imagesAttachments)</div><div class="line">            <span class="keyword">if</span> imagesAttachments.<span class="built_in">count</span> &gt; <span class="number">1</span> &#123;</div><div class="line">                height = <span class="type">FeedAnyImagesCell</span>.heightOfFeed(feed: feed)</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                height = <span class="type">FeedBiggerImageCell</span>.heightOfFeed(feed: feed)</div><div class="line">            &#125;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">break</span></div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">// 接下来就是根据 Feed 实例所携带的各种信息, 来计算 defaultLayout, </span></div><div class="line">        <span class="comment">// biggerImageLayout, anyImagesLayout </span></div><div class="line">        <span class="keyword">let</span> avatarImageViewFrame = <span class="type">CGRect</span>(x: <span class="number">15</span>, y: <span class="number">10</span>, width: <span class="number">40</span>, height: <span class="number">40</span>)</div><div class="line">        </div><div class="line">        <span class="keyword">let</span> nicknameLabelFrame: <span class="type">CGRect</span></div><div class="line">        <span class="keyword">let</span> categoryButtonFrame: <span class="type">CGRect</span></div><div class="line">        </div><div class="line">        <span class="keyword">if</span> <span class="keyword">let</span> category = <span class="type">FeedCategory</span>(rawValue: feed.category) &#123;</div><div class="line">            </div><div class="line">            <span class="keyword">let</span> rect = (category.rawValue <span class="keyword">as</span> <span class="type">NSString</span>).boundingRect(with: </div><div class="line">            <span class="type">CGSize</span>(width: <span class="number">320</span>, height: <span class="type">CGFloat</span>(<span class="type">FLT_MAX</span>)), options: </div><div class="line">            [.usesLineFragmentOrigin, .usesFontLeading], attributes: </div><div class="line">            <span class="type">Config</span>.<span class="type">FeedDetailCell</span>.categryButtonAttributies, context: <span class="literal">nil</span>)</div><div class="line">            </div><div class="line">            <span class="keyword">let</span> categoryButtonWidth = ceil(rect.width) + <span class="number">20</span></div><div class="line">            </div><div class="line">            categoryButtonFrame = <span class="type">CGRect</span>(x: screenWidth - categoryButtonWidth - </div><div class="line">            <span class="number">15</span>, y: <span class="number">19</span>, width: categoryButtonWidth, height: <span class="number">22</span>)</div><div class="line">            </div><div class="line">            <span class="keyword">let</span> nickNameLabelwidth = screenWidth - <span class="number">65</span> - <span class="number">15</span></div><div class="line">            nicknameLabelFrame = <span class="type">CGRect</span>(x: <span class="number">65</span>, y: <span class="number">21</span>, width: nickNameLabelwidth,</div><div class="line">             height: <span class="number">18</span>)</div><div class="line">            </div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">let</span> nickNameLabelwidth = screenWidth - <span class="number">65</span> - <span class="number">15</span></div><div class="line">            nicknameLabelFrame = <span class="type">CGRect</span>(x: <span class="number">65</span>, y: <span class="number">21</span>, width: nickNameLabelwidth, </div><div class="line">            height: <span class="number">18</span>)</div><div class="line">            categoryButtonFrame = <span class="type">CGRect</span>.zero</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">let</span> rect1 = (feed.contentBody! <span class="keyword">as</span> <span class="type">NSString</span>).boundingRect(with: </div><div class="line">        <span class="type">CGSize</span>(width: <span class="type">FeedBaseCell</span>.messageTextViewMaxWidth, height: </div><div class="line">        <span class="type">CGFloat</span>(<span class="type">FLT_MAX</span>)), options: [.usesFontLeading, .usesLineFragmentOrigin], </div><div class="line">        attributes: <span class="type">Config</span>.<span class="type">FeedDetailCell</span>.messageTextViewAttributies, context: </div><div class="line">        <span class="literal">nil</span>)</div><div class="line">        </div><div class="line">        <span class="keyword">let</span> messageTextViewHeight = ceil(rect1.height)</div><div class="line">        <span class="keyword">let</span> messageTextViewFrame = <span class="type">CGRect</span>(x: <span class="number">65</span>, y: <span class="number">54</span>, width: screenWidth - <span class="number">65</span> - </div><div class="line">        <span class="number">15</span>, height: messageTextViewHeight)</div><div class="line">        </div><div class="line">        <span class="keyword">let</span> leftBottomLabelOriginY = height - <span class="number">17</span> - <span class="number">15</span></div><div class="line">        <span class="keyword">let</span> leftBottomLabelFrame = <span class="type">CGRect</span>(x: <span class="number">65</span>, y: leftBottomLabelOriginY, width: </div><div class="line">        screenWidth - <span class="number">65</span> - <span class="number">85</span>, height: <span class="number">17</span>)</div><div class="line">        </div><div class="line">        <span class="keyword">let</span> messageCountLabelWidth: <span class="type">CGFloat</span> = <span class="number">30</span></div><div class="line">        <span class="keyword">let</span> messageConuntLabelFrame = <span class="type">CGRect</span>(x: screenWidth - </div><div class="line">        messageCountLabelWidth - <span class="number">39</span> - <span class="number">8</span>, y: leftBottomLabelOriginY, width: </div><div class="line">        messageCountLabelWidth, height: <span class="number">19</span>)</div><div class="line">        </div><div class="line">        <span class="keyword">let</span> discussionImageViewFrame = <span class="type">CGRect</span>(x: screenWidth - <span class="number">24</span> - <span class="number">15</span>, y: </div><div class="line">        leftBottomLabelOriginY - <span class="number">1</span>, width: <span class="number">24</span>, height: <span class="number">20</span>)</div><div class="line">        </div><div class="line">        <span class="keyword">let</span> defaultLayout = <span class="type">FeedCellLayout</span>.<span class="type">DefaultLayout</span>(</div><div class="line">            avatarImageViewFrame: avatarImageViewFrame,</div><div class="line">            nicknameLabelFrame: nicknameLabelFrame,</div><div class="line">            categoryButtonFrame: categoryButtonFrame,</div><div class="line">            messageTextViewFrame: messageTextViewFrame,</div><div class="line">            leftBottomLabelFrame: leftBottomLabelFrame,</div><div class="line">            messageCountLabelFrame: messageConuntLabelFrame,</div><div class="line">            discussionImageViewFrame: discussionImageViewFrame</div><div class="line">        )</div><div class="line">        </div><div class="line">        <span class="keyword">self</span>.defaultLayout = defaultLayout</div><div class="line">        </div><div class="line">        <span class="keyword">let</span> beginY = messageTextViewFrame.maxY + <span class="number">15</span></div><div class="line">        </div><div class="line">        <span class="keyword">switch</span> feed.attachment &#123;</div><div class="line">            </div><div class="line">        <span class="keyword">case</span> .<span class="type">Image</span>(<span class="keyword">let</span> imagesAttachments):</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> imagesAttachments.<span class="built_in">count</span> &gt; <span class="number">1</span> &#123;</div><div class="line">                </div><div class="line">                <span class="keyword">let</span> mediaCollectionViewFrame = <span class="type">CGRect</span>(origin: <span class="type">CGPoint</span>(x:<span class="number">65</span>, y:</div><div class="line">                 beginY), size: <span class="type">Config</span>.<span class="type">FeedAnyImagesCell</span>.mediaCollectionViewSize)</div><div class="line">                </div><div class="line">                <span class="keyword">self</span>.anyImagesLayout = <span class="type">AnyImagesLayout</span>(mediaCollectionViewFrame: </div><div class="line">                mediaCollectionViewFrame)</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> imagesAttachments.<span class="built_in">count</span> == <span class="number">1</span> &#123;</div><div class="line">                </div><div class="line">                <span class="keyword">let</span> biggerImageViewFrame = <span class="type">CGRect</span>(origin: <span class="type">CGPoint</span>(x: <span class="number">65</span>, y: </div><div class="line">                beginY), size: <span class="type">Config</span>.<span class="type">FeedBiggerImageCell</span>.imageSize)</div><div class="line">                <span class="keyword">let</span> biggerImageLayout = <span class="type">BiggerImageLayout</span>(biggerImageViewFrame: </div><div class="line">                biggerImageViewFrame)</div><div class="line">                <span class="keyword">self</span>.biggerImageLayout = biggerImageLayout</div><div class="line">            </div><div class="line">            &#125;</div><div class="line">            </div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">break</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>接下来我们来设计缓存逻辑, 我们定义个结构体, 外部只需要传入 Feed 实例, 就能正确得到其对应的 Layout 布局.  </p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">LayoutCatch</span> </span>&#123;</div><div class="line">    <span class="comment">// 定义一个字典, 存储 feed 对应的 FeedCellLayout,   用 feed 的 bjectID 做 key</span></div><div class="line">    <span class="keyword">var</span> feedCellLayoutHash = [<span class="type">String</span>: <span class="type">FeedCellLayout</span>]()</div><div class="line">    </div><div class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">feedCellLayoutOfFeed</span><span class="params">(feed: Feed)</span></span> -&gt; <span class="type">FeedCellLayout</span> &#123;</div><div class="line">        <span class="keyword">let</span> key = feed.objectId ?? <span class="string">""</span></div><div class="line">    </div><div class="line">        <span class="keyword">if</span> <span class="keyword">let</span> layout = feedCellLayoutHash[key] &#123;</div><div class="line">            <span class="keyword">return</span> layout</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">let</span> layout = <span class="type">FeedCellLayout</span>(feed: feed)</div><div class="line">            updateFeedCellLayout(layout: layout, forFeed: feed)</div><div class="line">            <span class="keyword">return</span> layout</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">updateFeedCellLayout</span><span class="params">(layout: FeedCellLayout, forFeed feed: Feed)</span></span> &#123;</div><div class="line">        <span class="keyword">let</span> key = feed.objectId ?? <span class="string">""</span></div><div class="line">        </div><div class="line">        <span class="keyword">if</span> !key.isEmpty &#123;</div><div class="line">            <span class="type">FeedCellLayoutHash</span>[key] = layout</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">heightOfFeed</span><span class="params">(feed: Feed)</span></span> -&gt; <span class="type">CGFloat</span> &#123;</div><div class="line">        <span class="keyword">let</span> layout = <span class="type">FeedCellLayoutOfFeed</span>(feed: feed)</div><div class="line">        <span class="keyword">return</span> layout.height</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>缓存逻辑完成之后, 我们为三种不同的 cell 样式分别添加 <code>configureWithFeed(feed: Feed, layout: FeedCellLayout, needshowCategory: Bool)</code> 的方法, 将计算好的 layout 应用到 cell.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//FeedBaseCell</span></div><div class="line"> <span class="function"><span class="keyword">func</span> <span class="title">configureWithFeed</span><span class="params">(feed: Feed, layout: FeedCellLayout, needshowCategory: </span></span></div><div class="line"> Bool) &#123;</div><div class="line">        <span class="keyword">self</span>.feed = feed</div><div class="line">        <span class="keyword">let</span> defaultLayout = layout.defaultLayout</div><div class="line">        </div><div class="line">        messageTextView.text = <span class="string">"<span class="subst">\(feed.contentBody!)</span>"</span>           </div><div class="line">        messageTextView.frame = defaultLayout.messageTextViewFrame</div><div class="line">        </div><div class="line">        nickNameLabel.text = feed.creator?.username ?? <span class="string">"iTychooo"</span></div><div class="line">        nickNameLabel.frame = defaultLayout.nicknameLabelFrame</div><div class="line">        </div><div class="line">        avatarImageView.image = <span class="type">UIImage</span>(named: <span class="string">"Howard"</span>)</div><div class="line">        avatarImageView.frame = defaultLayout.avatarImageViewFrame</div><div class="line">        </div><div class="line">        categoryButton.setTitle(feed.category, <span class="keyword">for</span>: .normal)</div><div class="line">        categoryButton.frame = defaultLayout.categoryButtonFrame</div><div class="line">        </div><div class="line">        </div><div class="line">        leftBottomLabel.text = <span class="string">"1小时前"</span></div><div class="line">        leftBottomLabel.frame = defaultLayout.leftBottomLabelFrame</div><div class="line">        discussionImageView.frame = defaultLayout.discussionImageViewFrame</div><div class="line">        </div><div class="line">        messageCountLabel.text = <span class="string">"10"</span></div><div class="line">        messageCountLabel.frame = defaultLayout.messageCountLabelFrame</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">    </div><div class="line"><span class="comment">//biggerImageCell</span></div><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">configureWithFeed</span><span class="params">(feed: Feed, layout: FeedCellLayout, </span></span></div><div class="line">needshowCategory: Bool) &#123;</div><div class="line">        <span class="keyword">super</span>.configureWithFeed(feed: feed, layout: layout, needshowCategory: </div><div class="line">        needshowCategory)</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> <span class="keyword">let</span> biggerImageLayout = layout.biggerImageLayout &#123;</div><div class="line">            biggerImageView.frame = biggerImageLayout.biggerImageViewFrame</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">switch</span> feed.attachment &#123;</div><div class="line">        <span class="keyword">case</span> .<span class="type">Image</span>(<span class="keyword">let</span> imageAttachments):</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> <span class="keyword">let</span> attachment = imageAttachments.first &#123;</div><div class="line">                <span class="comment">//大图还是使用原始大小的图片.</span></div><div class="line">                imageAttachment = attachment</div><div class="line">                biggerImageView.showActivityIndicatorWhenLoading = <span class="literal">true</span></div><div class="line">                biggerImageView.cube_setImageAtFeedCellWithAttachment(attachment: </div><div class="line">                attachment, withSize: <span class="literal">nil</span>)</div><div class="line">            &#125;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">break</span></div><div class="line">        &#125;</div><div class="line">        </div><div class="line"><span class="comment">// FeedAnyImagesCell</span></div><div class="line">    </div><div class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">configureWithFeed</span><span class="params">(feed: Feed, layout: FeedCellLayout, </span></span></div><div class="line">    needshowCategory: Bool) &#123;</div><div class="line">        <span class="keyword">super</span>.configureWithFeed(feed: feed, layout: layout, needshowCategory: </div><div class="line">        needshowCategory)</div><div class="line">        </div><div class="line">        <span class="keyword">switch</span> feed.attachment &#123;</div><div class="line">        <span class="keyword">case</span> .<span class="type">Image</span>(<span class="keyword">let</span> imageAttachments):</div><div class="line">            <span class="keyword">self</span>.imageAttachments = imageAttachments</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">break</span></div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> <span class="keyword">let</span> anyImagesLayout = layout.anyImagesLayout &#123;</div><div class="line">            mediaCollectionView.frame = anyImagesLayout.mediaCollectionViewFrame</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>最后, 我们在 TableViewController 的 <code>tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -&gt; UITableViewCell</code> 方法中, 配置 cell 就可以了.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Section</span>: <span class="title">Int</span> </span>&#123;</div><div class="line">    <span class="keyword">case</span> uploadingFeed = <span class="number">0</span></div><div class="line">    <span class="keyword">case</span> <span class="type">Feed</span></div><div class="line">    <span class="keyword">case</span> loadMore</div><div class="line">&#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, cellForRowAt indexPath: IndexPath)</span></span> -</div><div class="line"> &gt; <span class="type">UITableViewCell</span> &#123;</div><div class="line">    </div><div class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> section = <span class="type">Section</span>(rawValue: indexPath.section) <span class="keyword">else</span> &#123;</div><div class="line">        <span class="built_in">fatalError</span>()</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">cellForFeed</span><span class="params">(feed: Feed)</span></span> -&gt; <span class="type">UITableViewCell</span> &#123;</div><div class="line">        </div><div class="line">        <span class="keyword">switch</span> feed.attachment &#123;</div><div class="line">            </div><div class="line">        <span class="keyword">case</span> .<span class="type">Text</span>:</div><div class="line">            </div><div class="line">            <span class="keyword">let</span> cell = tableView.dequeueReusableCell(withIdentifier: </div><div class="line">            <span class="type">FeedBaseCellIdentifier</span>, <span class="keyword">for</span>: indexPath) <span class="keyword">as</span>! <span class="type">FeedBaseCell</span></div><div class="line">            cell.configureWithFeed(feed: feed, layout: </div><div class="line">            <span class="type">FeedsViewController</span>.layoutCatch.<span class="type">FeedCellLayoutOfFeed</span>(feed: feed), </div><div class="line">            needshowCategory: <span class="literal">false</span>)</div><div class="line">            <span class="keyword">return</span> cell</div><div class="line">            </div><div class="line">        <span class="keyword">case</span> .<span class="type">Image</span>(<span class="keyword">let</span> imagesAttachments):</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> imagesAttachments.<span class="built_in">count</span>  &gt; <span class="number">1</span> &#123;</div><div class="line">                </div><div class="line">                <span class="keyword">let</span> cell = tableView.dequeueReusableCell(withIdentifier: </div><div class="line">                <span class="type">FeedAnyImagesCellIdentifier</span>, <span class="keyword">for</span>: indexPath) <span class="keyword">as</span>! </div><div class="line">                <span class="type">FeedAnyImagesCell</span></div><div class="line">                </div><div class="line">                cell.configureWithFeed(feed: feed, layout: </div><div class="line">                <span class="type">FeedsViewController</span>.layoutCatch.<span class="type">FeedCellLayoutOfFeed</span>(feed: </div><div class="line">                feed), needshowCategory: <span class="literal">false</span>)</div><div class="line">                </div><div class="line">                <span class="keyword">return</span> cell</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="keyword">let</span> cell = tableView.dequeueReusableCell(withIdentifier: </div><div class="line">            <span class="type">FeedBiggerImageCellIdentifier</span>, <span class="keyword">for</span>: indexPath) <span class="keyword">as</span>! </div><div class="line">            <span class="type">FeedBiggerImageCell</span></div><div class="line">            </div><div class="line">            cell.configureWithFeed(feed: feed, layout: </div><div class="line">            <span class="type">FeedsViewController</span>.layoutCatch.<span class="type">FeedCellLayoutOfFeed</span>(feed: feed),</div><div class="line">             needshowCategory: <span class="literal">false</span>)</div><div class="line">            </div><div class="line">            <span class="keyword">return</span> cell</div><div class="line">            </div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> <span class="type">UITableViewCell</span>()</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">switch</span> section &#123;</div><div class="line">        </div><div class="line">    <span class="keyword">case</span> .uploadingFeed:</div><div class="line">        <span class="keyword">let</span> feed = uploadingFeeds[indexPath.row]</div><div class="line">        <span class="keyword">return</span> cellForFeed(feed: feed)</div><div class="line">        </div><div class="line">    <span class="keyword">case</span> .<span class="type">Feed</span>:</div><div class="line">        <span class="keyword">let</span> feed = feeds[indexPath.row]</div><div class="line">        <span class="keyword">return</span> cellForFeed(feed: feed)</div><div class="line">        </div><div class="line">    <span class="keyword">case</span> .loadMore:</div><div class="line">        </div><div class="line">        <span class="keyword">return</span> tableView.dequeueReusableCell(withIdentifier: </div><div class="line">        <span class="type">LoadMoreTableViewCellIdentifier</span>, <span class="keyword">for</span>: indexPath)</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>OK, Done! </p>
<p>感谢 Yep 的团队开源如此优秀的代码, 我从中学到了很多. 在浏览了大量 commit 后, 也了解了一个项目从无到有的大概过程, 对于我这种半路出家的自学者, 受益颇多.</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/07/08/如何在进行-Segue-跳转时避免直接使用字符串/" class="next">NEXT</a></div><div data-thread-key="2016/11/08/使用 Swift 优雅的缓存 Cell 的行高与 subviews 的 frame/" data-title="" data-url="http://yoursite.com/2016/11/08/使用 Swift 优雅的缓存 Cell 的行高与 subviews 的 frame/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"seansun"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2015 - 2016 <a href="http://yoursite.com">John Doe</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>