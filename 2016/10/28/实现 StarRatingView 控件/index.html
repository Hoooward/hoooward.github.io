<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 实现 StarRatingView 控件 · Hexo</title><meta name="description" content="实现 StarRatingView 控件 - John Doe"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Hexo"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/1855353313/" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/Hoooward" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">实现 StarRatingView 控件</h1><div class="post-info">Oct 28, 2016</div><div class="post-content"><p>自已项目中需要使用一个类此为 iTunes 中音乐评星的功能. 在 gihub 中找了一些发现都太繁琐. 本着一切从简, 能自己动手就自己动手的原则, 就参照开源的实现自己写了一个.</p>
<p>先来看看图片中我们要实现的控件.<br><img src="http://7xrfzx.com1.z0.glb.clouddn.com/2016-11-12-1.01.45.png" alt="1.01.45"><br>这个 <code>StarRatingView</code> 有两种状态, 分别是可编辑和不可编辑的状态. UI结构是一个 baseView 中拥有 5 个 <code>UIImageView</code>, 根据用户手指的移动 <code>CGPoint</code>, 为相应的 <code>UIImageView</code> 填充高亮或普通的 star 图片.<br><a id="more"></a></p>
<p>首先, 我们创建一个 <code>StarRatingView</code> 的类, 它继承自 UIView. </p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StarRatingView</span>: <span class="title">UIView</span> </span>&#123;</div><div class="line"></div><div class="line"> <span class="comment">// 普通的 star 图片</span></div><div class="line"> <span class="keyword">private</span> <span class="keyword">var</span> notSelectedImage: <span class="type">UIImage</span> = <span class="type">UIImage</span>(named: <span class="string">"star_empty"</span>)! &#123;</div><div class="line">        <span class="keyword">didSet</span> &#123;</div><div class="line">            refresh()</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"> <span class="comment">// 高亮的 star 图片  </span></div><div class="line"> <span class="keyword">private</span> <span class="keyword">var</span> halfSeletedImage: <span class="type">UIImage</span> = <span class="type">UIImage</span>(named: <span class="string">"star_full"</span>)! &#123;</div><div class="line">        <span class="keyword">didSet</span> &#123;</div><div class="line">            refresh()</div><div class="line">        &#125;</div><div class="line">    &#125; </div><div class="line"> </div><div class="line"> <span class="comment">// 是否可以编辑</span></div><div class="line"> <span class="meta">@IBInspectable</span> <span class="keyword">var</span> editable: <span class="type">Bool</span> = <span class="literal">true</span></div><div class="line"> </div><div class="line"> <span class="comment">// 当前高亮 star 的数量.</span></div><div class="line"> <span class="meta">@IBInspectable</span> <span class="keyword">var</span> rating: <span class="type">Int</span> = <span class="number">0</span> &#123;</div><div class="line">        <span class="keyword">didSet</span> &#123;</div><div class="line">            refresh()</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line"> <span class="comment">// 用来存储 StarRatingView 中所有的 星星 imageView</span></div><div class="line"> <span class="keyword">private</span> <span class="keyword">var</span> imageViews = [<span class="type">UIImageView</span>]()</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着我们定义一个<code>maxRating</code>属性, 它用来表示最大星星数量, 默认值是 5. 在它的 <code>didSet</code> 方法中, 我们进行 UIImageView 的初始化, 创建相应个数的 UIImageView.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> maxRating: <span class="type">Int</span> = <span class="number">5</span> &#123;</div><div class="line">        <span class="keyword">didSet</span> &#123;</div><div class="line">            imageViews.forEach &#123; $<span class="number">0</span>.removeFromSuperview() &#125;</div><div class="line">            imageViews.removeAll()</div><div class="line">            </div><div class="line">            <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;maxRating &#123;</div><div class="line">                <span class="keyword">let</span> imageView = <span class="type">UIImageView</span>()</div><div class="line">                imageView.contentMode = .scaleAspectFit</div><div class="line">                imageViews.append(imageView)</div><div class="line">                addSubview(imageView)</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            setNeedsLayout()</div><div class="line">            refresh()</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>之后我们来定义上面使用到的 <code>refresh</code> 方法, 它的逻辑非常简单, 就是遍历 imageViews 数组, 填充相应的图片.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">refresh</span><span class="params">()</span></span> &#123;  </div><div class="line">    imageViews.enumerated().forEach &#123;</div><div class="line">        index, imageView <span class="keyword">in</span></div><div class="line">        </div><div class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.rating &gt;= index + <span class="number">1</span> &#123;</div><div class="line">            imageView.image = fullSelectedImage</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            imageView.image = notSelectedImage</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着, 来处理 <code>StarRatingView</code> 的布局. 我们重写 <code>layoutSubviews</code> 的方法. 遍历 imageViews 数组, 为其设置计算好的 frame.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">var</span> midMargin: <span class="type">CGFloat</span> = <span class="number">0</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">var</span> leftMargin: <span class="type">CGFloat</span> = <span class="number">0</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">var</span> minImageSize: <span class="type">CGSize</span> = <span class="type">CGSize</span>.zero</div><div class="line">    </div><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">layoutSubviews</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">super</span>.layoutSubviews()</div><div class="line">    </div><div class="line">    <span class="keyword">var</span> desiredImageWidth: <span class="type">CGFloat</span> = <span class="number">0</span></div><div class="line">        </div><div class="line">    <span class="keyword">if</span> editable &#123;</div><div class="line">         desiredImageWidth = (<span class="keyword">self</span>.frame.size.width - (<span class="keyword">self</span>.leftMargin * <span class="number">2</span>) - </div><div class="line">         (<span class="keyword">self</span>.midMargin * <span class="type">CGFloat</span>(<span class="keyword">self</span>.imageViews.<span class="built_in">count</span>))) / </div><div class="line">         <span class="type">CGFloat</span>(<span class="keyword">self</span>.imageViews.<span class="built_in">count</span>)</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">         desiredImageWidth = <span class="keyword">self</span>.frame.size.width / <span class="number">5</span></div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">let</span> imageWidth = <span class="built_in">max</span>(<span class="keyword">self</span>.minImageSize.width, desiredImageWidth)</div><div class="line">        <span class="keyword">let</span> imageHeight = <span class="built_in">max</span>(<span class="keyword">self</span>.minImageSize.height, <span class="keyword">self</span>.frame.size.height)</div><div class="line">        </div><div class="line">        imageViews.enumerated().forEach &#123;</div><div class="line">            index, imageView <span class="keyword">in</span></div><div class="line">            </div><div class="line">            imageView.frame = <span class="type">CGRect</span>(x: <span class="keyword">self</span>.leftMargin + <span class="type">CGFloat</span>(index) * </div><div class="line">            (<span class="keyword">self</span>.midMargin + imageWidth), y: <span class="number">0</span>, width: imageWidth, height: </div><div class="line">            imageHeight)</div><div class="line">        &#125;  </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>最后我们来处理用户手指的触摸动作. 我们定义一个 private 的方法 <code>handleTouch(location: CGPoint)</code> 它接受一个用户点击的坐标. 以此来计算需要显示多少个 star.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleTouch</span><span class="params">(location: CGPoint)</span></span> &#123;</div><div class="line">      </div><div class="line">      <span class="keyword">if</span> !<span class="keyword">self</span>.editable &#123; <span class="keyword">return</span> &#125;</div><div class="line">      <span class="keyword">var</span> newRating = <span class="number">0</span></div><div class="line">      </div><div class="line">      <span class="keyword">for</span> (index, imageView) <span class="keyword">in</span> imageViews.enumerated().reversed() &#123;</div><div class="line">          <span class="keyword">if</span> location.x &gt; imageView.frame.origin.x &#123;</div><div class="line">              newRating = index + <span class="number">1</span></div><div class="line">              <span class="keyword">break</span></div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">self</span>.rating = newRating</div><div class="line"></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>这样我们就可以在 UIView 的响应触摸事件的方法中调用 <code>handleTouch(location: CGPoint)</code> 了.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">touchesBegan</span><span class="params">(<span class="number">_</span> touches: Set&lt;UITouch&gt;, with event: UIEvent?)</span></span> &#123;</div><div class="line">    <span class="keyword">let</span> touch = touches.first!</div><div class="line">    <span class="keyword">let</span> location = touch.location(<span class="keyword">in</span>: <span class="keyword">self</span>)</div><div class="line">    handleTouch(location: location)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">touchesMoved</span><span class="params">(<span class="number">_</span> touches: Set&lt;UITouch&gt;, with event: UIEvent?)</span></span> &#123;</div><div class="line">    <span class="keyword">let</span> touch = touches.first!</div><div class="line">    <span class="keyword">let</span> location = touch.location(<span class="keyword">in</span>: <span class="keyword">self</span>)</div><div class="line">    handleTouch(location: location)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>OK! Done.</p>
<p>在外部使用的时候, 我们可以指定其最大的 star 数量, 也可以通过 <code>ratring</code> 属性来控制当前高亮的 star 数量, 你也可以非常方便的更换 star 图片.</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/10/30/隐藏NavigationBar底部的实线/" class="prev">PREV</a><a href="/2016/10/20/刷新UITableView&amp;UICollectionView/" class="next">NEXT</a></div><div data-thread-key="2016/10/28/实现 StarRatingView 控件/" data-title="实现 StarRatingView 控件" data-url="http://yoursite.com/2016/10/28/实现 StarRatingView 控件/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"seansun"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2015 - 2017 <a href="http://yoursite.com">John Doe</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>